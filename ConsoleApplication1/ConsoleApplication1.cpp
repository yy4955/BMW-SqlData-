// ConsoleApplication1.cpp : 此文件包含 "main" 函数。程序执行将在此处开始并结束。
//

#include "pch.h"
#include "MyByteOperation.h"
#include "BMW_Sql_Deserialization.h"
#include "ExpressionCalculate.h"
//------------------------------------------------------------
//-----------       BMW原厂诊断软件SqlData提取和计算功能还原       -----------
//------        Date： 20200508          ------
//目前只解析了“&”，“！”，“|”，“Date”的逻辑运算
//------------------------------------------------------------

//01010000000207000000118BEB2903000000000B8DCB8C0F000000118BEB2903000000008B002A0300000000118BEB2903000000000B092A0300000000118BEB290300000000EC39AAA330120000
//118BEB2903000000000BF8290300000000118BEB2903000000008BEF290300000000118BEB290300000000963D23A530120000

/*
01 01000000 02 07000000 11 8BEB2903000000000 B8DCB8C0F000000 11 8BEB2903000000008B002A0300000000 11 8BEB2903000000000B092A0300000000 11 8BEB290300000000EC39AAA330120000 11\
		8BEB2903000000000BF8290300000000 11 8BEB2903000000008BEF290300000000 11 8BEB290300000000963D23A530120000"
[0]逻辑标识符预判  
[1-4]外循环次数
[5]逻辑标识符识别
[6-9]内循环次数
[10]逻辑标识符识别
[11-27]ClassID 8位  +  valueID 8位
01 03000000 11 8BEB2903000000000 B092A0300000000 03 11 8B112A0300000000 8BF02C0300000000 02 02000000 11 8B6B36250A0000000 B7B36250A000000 11 8B6B36250A000000 8B8436250A000000
(Marke=BMW PKW [53078923=53086475] AND NOT E-Bezeichnung=E89 [53088651=53276811] AND (Produktlinie=PL2 [43573996427=43574000395] OR Produktlinie=PL6-alt [43573996427=43574002827]))
0103000000118BEB2903000000000B092A030000000003118B112A03000000008BF02C03000000000202000000118B6B36250A0000000B7B36250A000000118B6B36250A0000008B8436250A000000

  IStufeX:
 rule id: 5357089547 rule: (((Marke=BMW PKW [53078923=53086475] OR Marke=MINI PKW [53078923=53082123] OR Marke=ROLLS-ROYCE PKW [53078923=53079947]) AND IStufeX: HO-I-Stufe GREATER_EQUAL 'F001-10-09-500' [40564650763] AND IStufeX: HO-I-Stufe LESS_EQUAL 'F001-11-03-500' [53945038091]) OR ((Marke=BMW PKW [53078923=53086475] OR Marke=MINI PKW [53078923=53082123] OR Marke=ROLLS-ROYCE PKW [53078923=53079947]) AND IStufeX: HO-I-Stufe GREATER_EQUAL 'F010-10-09-500' [40564717195] AND IStufeX: HO-I-Stufe LESS_EQUAL 'F010-11-03-500' [40564736907]) OR ((Marke=BMW PKW [53078923=53086475] OR Marke=MINI PKW [53078923=53082123] OR Marke=ROLLS-ROYCE PKW [53078923=53079947]) AND NOT Baureihenverbund=F001 [45414283=13608927115] AND NOT Baureihenverbund=F010 [45414283=13609012363]))
 
020300000001030000000203000000118BEB2903000000000B092A0300000000118BEB2903000000000BF8290300000000118BEB2903000000008BEF2903000000001403000B73D771090000001405000BF55F8F0C00000001030000000203000000118BEB2903000000000B092A0300000000118BEB2903000000000BF8290300000000118BEB2903000000008BEF2903000000001403008B76D871090000001405008BC3D8710900000001030000000203000000118BEB2903000000000B092A0300000000118BEB2903000000000BF8290300000000118BEB2903000000008BEF29030000000003118BF7B402000000008BBF272B0300000003118BF7B402000000008B0C292B03000000

date:
 rule id: 1033674251 rule: ((Marke=BMW PKW [53078923=53086475] AND E-Bezeichnung=E68 [53088651=53094027] AND EcuClique=1037900171 AND Baustand >= 200703) OR (Marke=BMW PKW [53078923=53086475] AND (E-Bezeichnung=E60 [53088651=53202827] OR E-Bezeichnung=E61 [53088651=53268107] OR E-Bezeichnung=E63 [53088651=53259403] OR E-Bezeichnung=E64 [53088651=53263755] OR E-Bezeichnung=E65 [53088651=53218059] OR E-Bezeichnung=E66 [53088651=53296395] OR E-Bezeichnung=E67 [53088651=53287691] OR E-Bezeichnung=E81 [53088651=53089675] OR E-Bezeichnung=E82 [53088651=53200651] OR E-Bezeichnung=E84 [53088651=53233291] OR E-Bezeichnung=E87 [53088651=53222411] OR E-Bezeichnung=E88 [53088651=53270283] OR E-Bezeichnung=E90 [53088651=53137547] OR E-Bezeichnung=E91 [53088651=53228939] OR E-Bezeichnung=E92 [53088651=53146251] OR E-Bezeichnung=E93 [53088651=53107083]) AND (EcuClique=1037897611 OR EcuClique=1037900171) AND Baustand >= 200609))

02 02000000 01 04000000 11 8BEB2903000000000 B092A0300000000 11 8B112A0300000000 8B262A0300000000 0C 8B19DD3D00000000 04 03 FF0F030000000000 01 04000000 118BEB2903000000000B092A03000000000210000000118B112A03000000008BCF2B0300000000118B112A03000000008BCE2C0300000000118B112A03000000008BAC2C0300000000118B112A03000000008BBD2C0300000000118B112A03000000000B0B2C0300000000118B112A03000000000B3D2D0300000000118B112A03000000000B1B2D0300000000118B112A03000000008B152A0300000000118B112A03000000000BC72B0300000000118B112A03000000008B462C0300000000118B112A03000000000B1C2C0300000000118B112A03000000000BD72C0300000000118B112A03000000008BD02A0300000000118B112A03000000008B352C0300000000118B112A03000000008BF22A0300000000118B112A03000000008B592A030000000002020000000C8B0FDD3D000000000C8B19DD3D00000000 04 03 A10F0300 00 00 00 00
*/

void test()
{
	const char *strTest = "CED2CAC7B8F6B4F3D0DCC3A8";
	auto charVec = hexToBin(strTest);
	for (auto element : charVec) {
		std::cout << element;
	}
	std::cout << std::endl;
	auto strHex = binToHex(charVec.data(), charVec.size());
	std::cout << strHex << std::endl;
	//vector 转string
	std::string stBuf;
	stBuf.assign(strHex.begin(), strHex.end());
	system("pause");
}

//逻辑表达式解析逻辑运算测试
void booltest(std::string str)
{
	//([true] & ( ! [true]) & ([true] | [true]))
	//([53078923=53086475] & ( ! [53088651=53276811]) & ([43573996427=43574000395] | [43573996427=43574002827]))

	//初始化运算类型switch string
	Initialize();
	bool b = splitRPN(str);
	std::cout << str << std::boolalpha << b <<std::endl;
}

//sqlBin解析逻辑表达式测试
void test(std::stringstream &istream)
{
	//std::stringstream  istream;
	std::stringstream  istreamA;
	std::string strSql;
	std::string str = "";
	istream >> str;
	auto vectorHex = hexToBin(str);
	str = "";
	str.clear();	
	str.assign(vectorHex.begin(), vectorHex.end());
	istreamA << str;
	//debug

	SwitchLogType(istreamA, strSql);

	//写文件
	std::ofstream outfile;
	outfile.open("Sql解析.txt", std::ios::binary | std::ios::app);
	if (!outfile.is_open())
	{
		printf("%s\r\n",strerror(errno));
	}
	outfile << strSql << "\r\n";
	outfile.close();
}

int main()
{
	/*
	53078923=53086475
53088651=53241995
63826443=64371467
date 200202
	*/
	G_mapHash.insert(std::make_pair("53078923", 53079947));
	G_mapHash.insert(std::make_pair("43573996427", 43574002827));
	//G_mapHash.insert(std::make_pair("63826443", 64232203));
	//G_mapHash.insert(std::make_pair("DATE", 200109));
	//G_mapHash.insert(std::make_pair("53046411", 53071371));

	
	std::stringstream  istream("01090000000204000000118BEB2903000000000B8DCB8C0F000000118BEB2903000000000B092A0300000000118BEB2903000000000BF8290300000000118BEB2903000000008BEF29030000000003118B6B36250A0000009461F6B33012000003118B6B36250A0000000B7B36250A00000003118B6B36250A0000000BB436250A00000003118B6B36250A0000008BBD36250A00000003118B6B36250A0000000B8E36250A00000003118B6B36250A0000000BA136250A00000003118B6B36250A0000008B9736250A00000003118B6B36250A0000008B8436250A000000");


	booltest("(([53078923=66786659595] | [53078923=53086475] | [53078923=53082123] | [53078923=53079947]) & ( ! [43573996427=20000386998676]) & ( ! [43573996427=43574000395]) & ( ! [43573996427=43574014987]) & ( ! [43573996427=43574017419]) & ( ! [43573996427=43574005259]) & ( ! [43573996427=43574010123]) & ( ! [43573996427=43574007691]) & ( ! [43573996427=43574002827]))");
	std::string strFile;
	std::ifstream ifile;
	if (ifile.is_open())
	{
		printf("%s\r\n", strerror(errno));
		getline(ifile, strFile);
	}
}

// 运行程序: Ctrl + F5 或调试 >“开始执行(不调试)”菜单
// 调试程序: F5 或调试 >“开始调试”菜单

// 入门提示: 
//   1. 使用解决方案资源管理器窗口添加/管理文件
//   2. 使用团队资源管理器窗口连接到源代码管理
//   3. 使用输出窗口查看生成输出和其他消息
//   4. 使用错误列表窗口查看错误
//   5. 转到“项目”>“添加新项”以创建新的代码文件，或转到“项目”>“添加现有项”以将现有代码文件添加到项目
//   6. 将来，若要再次打开此项目，请转到“文件”>“打开”>“项目”并选择 .sln 文件
